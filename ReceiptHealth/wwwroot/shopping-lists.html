<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Lists - ReceiptHealth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        nav {
            margin-top: 20px;
        }

        nav a {
            color: #667eea;
            text-decoration: none;
            margin-right: 20px;
            font-weight: 500;
        }

        nav a:hover {
            text-decoration: underline;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin-right: 10px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        .list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .list-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .list-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .list-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .list-meta {
            color: #666;
            font-size: 0.9em;
        }

        .item-list {
            list-style: none;
            margin-top: 20px;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item.purchased {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .item-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            color: #333;
        }

        .item-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            margin-right: 5px;
        }

        .category-healthy {
            background: #d4edda;
            color: #155724;
        }

        .category-junk {
            background: #f8d7da;
            color: #721c24;
        }

        .category-other {
            background: #d1ecf1;
            color: #0c5460;
        }

        .category-unknown {
            background: #e2e3e5;
            color: #383d41;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .alert.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert.warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõí Shopping Lists</h1>
            <p>Manage your shopping lists and track prices</p>
            <nav>
                <a href="/">Dashboard</a>
                <a href="/receipts.html">Receipts</a>
                <a href="/insights.html">Insights</a>
                <a href="/shopping-lists.html">Shopping Lists</a>
                <a href="/achievements.html">Achievements</a>
            </nav>
        </header>

        <div class="card">
            <h2>Your Shopping Lists</h2>
            <button class="btn" onclick="showCreateListModal()">‚ûï Create New List</button>
            <button class="btn btn-success" onclick="generateHealthyList()">ü•ó Generate Healthy List</button>
            
            <div id="listsContainer" class="list-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading shopping lists...
                </div>
            </div>
        </div>

        <div id="priceAlertsCard" class="card" style="display: none;">
            <h2>üí∞ Price Alerts</h2>
            <div id="priceAlertsContainer"></div>
        </div>
    </div>

    <!-- Create List Modal -->
    <div id="createListModal" class="modal">
        <div class="modal-content">
            <h3>Create Shopping List</h3>
            <div class="form-group">
                <label>List Name</label>
                <input type="text" id="listName" placeholder="e.g., Weekly Groceries">
            </div>
            <button class="btn" onclick="createList()">Create</button>
            <button class="btn btn-secondary" onclick="hideCreateListModal()">Cancel</button>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <h3>Add Item</h3>
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="itemName" placeholder="e.g., Bananas">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="itemQuantity" value="1" min="1">
            </div>
            <button class="btn" onclick="addItem()">Add</button>
            <button class="btn btn-secondary" onclick="hideAddItemModal()">Cancel</button>
        </div>
    </div>

    <!-- View List Modal -->
    <div id="viewListModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="listTitle" style="margin: 0;"></h3>
                <button class="btn btn-danger btn-small" onclick="deleteList()">üóëÔ∏è Delete List</button>
            </div>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showAddItemModal()">‚ûï Add Item</button>
                <button class="btn btn-secondary" onclick="hideViewListModal()">Close</button>
            </div>
            <ul id="itemsList" class="item-list"></ul>
        </div>
    </div>

    <script>
        let currentListId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadLists();
        });

        async function loadLists() {
            const container = document.getElementById('listsContainer');
            try {
                const response = await fetch('/api/shopping-lists');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const lists = await response.json();

                if (!lists || lists.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #999; padding: 40px;">üõí No shopping lists yet. Create one to get started!</p>';
                    return;
                }

                container.innerHTML = lists.map(list => `
                    <div class="list-card" onclick="viewList(${list.id})">
                        <h3>${list.name}</h3>
                        <div class="list-meta">
                            ${list.items?.length || 0} items
                            ‚Ä¢ ${list.items?.filter(i => i.isPurchased).length || 0} purchased
                        </div>
                        <div class="list-meta" style="margin-top: 5px;">
                            Created: ${new Date(list.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading shopping lists:', error);
                container.innerHTML = `<p style="grid-column: 1 / -1; color: red; text-align: center; padding: 20px;">‚ö†Ô∏è Unable to load shopping lists. Please ensure the server is running.<br><small>${error.message}</small></p>`;
            }
        }

        async function viewList(listId) {
            currentListId = listId;
            try {
                const response = await fetch(`/api/shopping-lists/${listId}`);
                const list = await response.json();

                document.getElementById('listTitle').textContent = list.name;
                const itemsList = document.getElementById('itemsList');
                
                if (list.items.length === 0) {
                    itemsList.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">No items in this list yet.</li>';
                } else {
                    itemsList.innerHTML = list.items.map(item => {
                        const categoryClass = `category-${item.category.toLowerCase()}`;
                        return `
                            <li class="item ${item.isPurchased ? 'purchased' : ''}">
                                <input type="checkbox" 
                                       class="item-checkbox" 
                                       ${item.isPurchased ? 'checked' : ''}
                                       onchange="toggleItemPurchased(${item.id}, this.checked)">
                                <div class="item-details">
                                    <div class="item-name">
                                        ${item.itemName} 
                                        <span class="category-badge ${categoryClass}">${item.category}</span>
                                    </div>
                                    <div class="item-meta">
                                        Qty: ${item.quantity}
                                        ${item.lastKnownPrice ? ` ‚Ä¢ Last price: $${item.lastKnownPrice.toFixed(2)}` : ''}
                                        ${item.lastKnownVendor ? ` @ ${item.lastKnownVendor}` : ''}
                                    </div>
                                </div>
                                <button class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9em;" 
                                        onclick="event.stopPropagation(); removeItem(${item.id})">
                                    üóëÔ∏è
                                </button>
                            </li>
                        `;
                    }).join('');
                }

                document.getElementById('viewListModal').classList.add('show');
                loadPriceAlerts(listId);
            } catch (error) {
                alert(`Failed to load list: ${error.message}`);
            }
        }

        async function loadPriceAlerts(listId) {
            try {
                const response = await fetch(`/api/shopping-lists/${listId}/price-alerts`);
                const alerts = await response.json();

                const card = document.getElementById('priceAlertsCard');
                const container = document.getElementById('priceAlertsContainer');

                if (alerts.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';
                container.innerHTML = alerts.map(alert => `
                    <div class="alert success">
                        <strong>üí∞ ${alert.itemName}</strong> is on sale!<br>
                        Now: $${alert.currentPrice.toFixed(2)} (was $${alert.previousPrice.toFixed(2)}) at ${alert.vendor}<br>
                        Save $${alert.savingsAmount.toFixed(2)} (${alert.savingsPercent.toFixed(0)}% off)
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load price alerts:', error);
            }
        }

        function showCreateListModal() {
            document.getElementById('createListModal').classList.add('show');
        }

        function hideCreateListModal() {
            document.getElementById('createListModal').classList.remove('show');
            document.getElementById('listName').value = '';
        }

        function showAddItemModal() {
            document.getElementById('addItemModal').classList.add('show');
        }

        function hideAddItemModal() {
            document.getElementById('addItemModal').classList.remove('show');
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '1';
        }

        function hideViewListModal() {
            document.getElementById('viewListModal').classList.remove('show');
            currentListId = null;
        }

        async function createList() {
            const name = document.getElementById('listName').value.trim();
            if (!name) {
                alert('Please enter a list name');
                return;
            }

            try {
                const response = await fetch('/api/shopping-lists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    hideCreateListModal();
                    loadLists();
                } else {
                    alert('Failed to create list');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function generateHealthyList() {
            if (!confirm('Generate a shopping list from your healthy purchases in the last 30 days?')) {
                return;
            }

            try {
                console.log('ü•ó Generating healthy list...');
                const response = await fetch('/api/shopping-lists/generate?daysBack=30', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    console.log('‚úÖ Healthy list generated');
                    await loadLists();
                    const result = await response.json();
                    alert(`‚úÖ Healthy shopping list "${result.name}" generated with ${result.items?.length || 0} items!`);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Failed to generate list:', errorData);
                    alert(`Failed to generate list: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error generating list:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function addItem() {
            const itemName = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value);

            if (!itemName) {
                alert('Please enter an item name');
                return;
            }

            try {
                console.log('Adding item:', { listId: currentListId, itemName, quantity });
                const response = await fetch(`/api/shopping-lists/${currentListId}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemName, quantity })
                });

                if (response.ok) {
                    console.log('‚úÖ Item added successfully');
                    hideAddItemModal();
                    await viewList(currentListId);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Failed to add item:', errorData);
                    alert(`Failed to add item: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error adding item:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function toggleItemPurchased(itemId, isPurchased) {
            try {
                await fetch(`/api/shopping-lists/items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isPurchased })
                });
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function removeItem(itemId) {
            if (!confirm('Remove this item from the list?')) {
                return;
            }

            try {
                const response = await fetch(`/api/shopping-lists/items/${itemId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await viewList(currentListId);
                } else {
                    alert('Failed to remove item');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function deleteList() {
            if (!confirm('Delete this entire shopping list? This cannot be undone.')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Deleting list:', currentListId);
                const response = await fetch(`/api/shopping-lists/${currentListId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('‚úÖ List deleted');
                    hideViewListModal();
                    await loadLists();
                    alert('‚úÖ Shopping list deleted');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Failed to delete list:', errorData);
                    alert(`Failed to delete list: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error deleting list:', error);
                alert(`Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
