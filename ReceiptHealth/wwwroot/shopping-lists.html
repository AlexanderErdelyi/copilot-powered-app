<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Lists - ReceiptHealth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 8px;
        }

        header p {
            color: #666;
            font-size: 16px;
            margin-bottom: 15px;
        }

        nav {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        nav a {
            text-decoration: none;
            color: #667eea;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.3s;
        }

        nav a:hover, nav a.active {
            background: #667eea;
            color: white;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin-right: 10px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        .list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .list-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .list-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .list-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .list-meta {
            color: #666;
            font-size: 0.9em;
        }

        .list-section {
            margin-bottom: 30px;
        }

        .list-section h4 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .item-tile {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .item-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .item-tile.purchased {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            opacity: 0.7;
        }

        .item-tile.frequent {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            opacity: 0.8;
        }

        .item-tile-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
            line-height: 1;
        }

        .item-tile-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
            line-height: 1;
        }

        .item-tile-name {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .item-tile-qty {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .item-tile-price {
            font-size: 0.8em;
            opacity: 0.85;
            margin-top: 5px;
        }

        .empty-section {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            margin-right: 5px;
        }

        .category-healthy {
            background: #d4edda;
            color: #155724;
        }

        .category-junk {
            background: #f8d7da;
            color: #721c24;
        }

        .category-other {
            background: #d1ecf1;
            color: #0c5460;
        }

        .category-unknown {
            background: #e2e3e5;
            color: #383d41;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .alert.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert.warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Wake Word Listener -->
    <link rel="stylesheet" href="/wake-word-styles.css">
    <script src="/wake-word-listener.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõí Shopping Lists</h1>
            <p>Manage your shopping lists and track prices</p>
            <nav>
                <a href="/">Dashboard</a>
                <a href="/receipts.html">Receipts</a>
                <a href="/insights.html">Insights</a>
                <a href="/shopping-lists.html">Shopping Lists</a>
                <a href="/meal-planner.html">Meal Planner</a>
                <a href="/achievements.html">Achievements</a>
                <a href="/voice-assistant.html">Voice Assistant</a>
            </nav>
        </header>

        <div class="card">
            <h2>Your Shopping Lists</h2>
            <button class="btn" onclick="showCreateListModal()">‚ûï Create New List</button>
            <button class="btn btn-success" onclick="generateHealthyList()">ü•ó Generate Healthy List</button>
            
            <div id="listsContainer" class="list-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading shopping lists...
                </div>
            </div>
        </div>

        <div id="priceAlertsCard" class="card" style="display: none;">
            <h2>üí∞ Price Alerts</h2>
            <div id="priceAlertsContainer"></div>
        </div>
    </div>

    <!-- Create List Modal -->
    <div id="createListModal" class="modal">
        <div class="modal-content">
            <h3>Create Shopping List</h3>
            <div class="form-group">
                <label>List Name</label>
                <input type="text" id="listName" placeholder="e.g., Weekly Groceries">
            </div>
            <button class="btn" onclick="createList()">Create</button>
            <button class="btn btn-secondary" onclick="hideCreateListModal()">Cancel</button>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <h3>Add Item</h3>
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="itemName" placeholder="e.g., Bananas">
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="itemQuantity" value="1" min="1">
            </div>
            <button class="btn" onclick="addItem()">Add</button>
            <button class="btn btn-secondary" onclick="hideAddItemModal()">Cancel</button>
        </div>
    </div>

    <!-- View List Modal -->
    <div id="viewListModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="listTitle" style="margin: 0;"></h3>
                <button class="btn btn-danger btn-small" onclick="deleteList()">üóëÔ∏è Delete List</button>
            </div>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="showAddItemModal()">‚ûï Add Item</button>
                <button class="btn btn-secondary" onclick="hideViewListModal()">Close</button>
            </div>
            
            <!-- To Buy Section -->
            <div class="list-section">
                <h4>üõí To Buy</h4>
                <div id="toBuyItems" class="items-grid"></div>
            </div>
            
            <!-- Purchased Section -->
            <div class="list-section" id="purchasedSection" style="display: none;">
                <h4>‚úÖ Purchased</h4>
                <div id="purchasedItems" class="items-grid"></div>
            </div>
            
            <!-- Frequently Bought Section -->
            <div class="list-section" id="frequentSection" style="display: none;">
                <h4>üîÅ Frequently Bought</h4>
                <div id="frequentItems" class="items-grid"></div>
            </div>
        </div>
    </div>

    <script>
        let currentListId = null;

        // Get emoji icon for item
        function getItemIcon(itemName) {
            const name = itemName.toLowerCase();
            
            // Fruits
            if (name.includes('apple')) return 'üçé';
            if (name.includes('banana')) return 'üçå';
            if (name.includes('orange')) return 'üçä';
            if (name.includes('lemon')) return 'üçã';
            if (name.includes('strawberry') || name.includes('berries')) return 'üçì';
            if (name.includes('grape')) return 'üçá';
            if (name.includes('watermelon')) return 'üçâ';
            if (name.includes('peach')) return 'üçë';
            if (name.includes('cherry')) return 'üçí';
            if (name.includes('pineapple')) return 'üçç';
            if (name.includes('mango')) return 'ü•≠';
            if (name.includes('avocado')) return 'ü•ë';
            
            // Vegetables
            if (name.includes('tomato')) return 'üçÖ';
            if (name.includes('carrot')) return 'ü•ï';
            if (name.includes('broccoli')) return 'ü•¶';
            if (name.includes('lettuce') || name.includes('salad')) return 'ü•¨';
            if (name.includes('potato')) return 'ü•î';
            if (name.includes('corn')) return 'üåΩ';
            if (name.includes('pepper')) return 'üå∂Ô∏è';
            if (name.includes('cucumber')) return 'ü•í';
            if (name.includes('onion')) return 'üßÖ';
            if (name.includes('garlic')) return 'üßÑ';
            if (name.includes('mushroom')) return 'üçÑ';
            if (name.includes('spinach')) return 'ü•¨';
            
            // Dairy & Eggs
            if (name.includes('milk')) return 'ü•õ';
            if (name.includes('cheese')) return 'üßÄ';
            if (name.includes('butter')) return 'üßà';
            if (name.includes('egg')) return 'ü•ö';
            if (name.includes('yogurt')) return 'ü•õ';
            
            // Meat & Protein
            if (name.includes('chicken')) return 'üçó';
            if (name.includes('beef') || name.includes('steak')) return 'ü•©';
            if (name.includes('bacon')) return 'ü•ì';
            if (name.includes('fish')) return 'üêü';
            if (name.includes('shrimp')) return 'üç§';
            
            // Bread & Bakery
            if (name.includes('bread')) return 'üçû';
            if (name.includes('bagel')) return 'ü•Ø';
            if (name.includes('croissant')) return 'ü•ê';
            if (name.includes('cookie')) return 'üç™';
            if (name.includes('cake')) return 'üç∞';
            if (name.includes('donut')) return 'üç©';
            
            // Beverages
            if (name.includes('coffee')) return '‚òï';
            if (name.includes('tea')) return 'üçµ';
            if (name.includes('juice')) return 'üßÉ';
            if (name.includes('water')) return 'üíß';
            if (name.includes('soda') || name.includes('cola')) return 'ü•§';
            if (name.includes('beer')) return 'üç∫';
            if (name.includes('wine')) return 'üç∑';
            
            // Snacks & Sweets
            if (name.includes('chips') || name.includes('crisp')) return 'üçü';
            if (name.includes('chocolate')) return 'üç´';
            if (name.includes('candy')) return 'üç¨';
            if (name.includes('ice cream')) return 'üç¶';
            if (name.includes('popcorn')) return 'üçø';
            
            // Meals
            if (name.includes('pizza')) return 'üçï';
            if (name.includes('burger')) return 'üçî';
            if (name.includes('taco')) return 'üåÆ';
            if (name.includes('pasta')) return 'üçù';
            if (name.includes('rice')) return 'üçö';
            if (name.includes('soup')) return 'üç≤';
            if (name.includes('sandwich')) return 'ü•™';
            
            // Other
            if (name.includes('honey')) return 'üçØ';
            if (name.includes('oil')) return 'ü´í';
            if (name.includes('salt') || name.includes('spice')) return 'üßÇ';
            
            // Default
            return 'üõí';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadLists();
        });

        async function loadLists() {
            const container = document.getElementById('listsContainer');
            try {
                const response = await fetch('/api/shopping-lists');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const lists = await response.json();

                if (!lists || lists.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #999; padding: 40px;">üõí No shopping lists yet. Create one to get started!</p>';
                    return;
                }

                container.innerHTML = lists.map(list => `
                    <div class="list-card" onclick="viewList(${list.id})">
                        <h3>${list.name}</h3>
                        <div class="list-meta">
                            ${list.items?.length || 0} items
                            ‚Ä¢ ${list.items?.filter(i => i.isPurchased).length || 0} purchased
                        </div>
                        <div class="list-meta" style="margin-top: 5px;">
                            Created: ${new Date(list.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading shopping lists:', error);
                container.innerHTML = `<p style="grid-column: 1 / -1; color: red; text-align: center; padding: 20px;">‚ö†Ô∏è Unable to load shopping lists. Please ensure the server is running.<br><small>${error.message}</small></p>`;
            }
        }

        async function viewList(listId) {
            currentListId = listId;
            try {
                const response = await fetch(`/api/shopping-lists/${listId}`);
                const list = await response.json();

                document.getElementById('listTitle').textContent = list.name;
                
                // Separate items into categories
                const toBuy = list.items.filter(item => !item.isPurchased);
                const purchased = list.items.filter(item => item.isPurchased);
                
                // Render To Buy section
                const toBuyContainer = document.getElementById('toBuyItems');
                if (toBuy.length === 0) {
                    toBuyContainer.innerHTML = '<div class="empty-section">No items to buy. Add some items! üõí</div>';
                } else {
                    toBuyContainer.innerHTML = toBuy.map(item => `
                        <div class="item-tile" onclick="toggleItemPurchased(${item.id}, true)" title="Click to mark as purchased">
                            <span class="item-tile-icon">${getItemIcon(item.itemName)}</span>
                            <div class="item-tile-name">${item.itemName}</div>
                            <div class="item-tile-qty">Qty: ${item.quantity}</div>
                            ${item.lastKnownPrice ? `<div class="item-tile-price">$${item.lastKnownPrice.toFixed(2)}</div>` : ''}
                        </div>
                    `).join('');
                }
                
                // Render Purchased section
                const purchasedSection = document.getElementById('purchasedSection');
                const purchasedContainer = document.getElementById('purchasedItems');
                if (purchased.length === 0) {
                    purchasedSection.style.display = 'none';
                } else {
                    purchasedSection.style.display = 'block';
                    purchasedContainer.innerHTML = purchased.map(item => `
                        <div class="item-tile purchased" onclick="toggleItemPurchased(${item.id}, false)" title="Click to move back to To Buy">
                            <span class="item-tile-icon">${getItemIcon(item.itemName)}</span>
                            <div class="item-tile-name">${item.itemName}</div>
                            <div class="item-tile-qty">Qty: ${item.quantity}</div>
                            ${item.lastKnownPrice ? `<div class="item-tile-price">$${item.lastKnownPrice.toFixed(2)}</div>` : ''}
                        </div>
                    `).join('');
                }
                
                // Load frequently bought items
                await loadFrequentlyBought(listId);

                document.getElementById('viewListModal').classList.add('show');
                loadPriceAlerts(listId);
            } catch (error) {
                alert(`Failed to load list: ${error.message}`);
            }
        }
        
        async function loadFrequentlyBought(listId) {
            const frequentSection = document.getElementById('frequentSection');
            const frequentContainer = document.getElementById('frequentItems');
            
            try {
                // Fetch frequently bought items from receipts
                const response = await fetch('/api/receipts');
                const receipts = await response.json();
                
                console.log('üìä Loaded receipts:', receipts.length);
                
                if (receipts.length === 0) {
                    frequentSection.style.display = 'block';
                    frequentContainer.innerHTML = '<div class="empty-section">Upload some receipts to see frequently bought items! üìä<br><small>The system will analyze your purchase history and suggest commonly bought items.</small></div>';
                    return;
                }
                
                // Count item frequencies from all receipts
                const itemFrequency = {};
                receipts.forEach(receipt => {
                    if (receipt.lineItems && receipt.lineItems.length > 0) {
                        receipt.lineItems.forEach(lineItem => {
                            const name = lineItem.description.toLowerCase().trim();
                            if (!itemFrequency[name]) {
                                itemFrequency[name] = {
                                    name: lineItem.description,
                                    count: 0,
                                    avgPrice: 0,
                                    totalPrice: 0,
                                    vendor: receipt.vendor
                                };
                            }
                            itemFrequency[name].count++;
                            itemFrequency[name].totalPrice += lineItem.price || 0;
                        });
                    }
                });
                
                console.log('üì¶ Item frequencies:', Object.keys(itemFrequency).length);
                
                // Calculate average prices
                Object.values(itemFrequency).forEach(item => {
                    item.avgPrice = item.totalPrice / item.count;
                });
                
                // Get current list items to exclude them
                const currentListResponse = await fetch(`/api/shopping-lists/${listId}`);
                const currentList = await currentListResponse.json();
                const currentItemNames = currentList.items.map(i => i.itemName.toLowerCase().trim());
                
                // Filter and sort by frequency (exclude items already in list)
                const frequentItems = Object.values(itemFrequency)
                    .filter(item => item.count >= 2 && !currentItemNames.includes(item.name.toLowerCase().trim()))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 12); // Show top 12
                
                console.log('üîÅ Frequent items to show:', frequentItems.length);
                
                if (frequentItems.length === 0) {
                    frequentSection.style.display = 'block';
                    frequentContainer.innerHTML = '<div class="empty-section">No frequently bought items to suggest yet.<br><small>Items you\'ve bought 2+ times will appear here!</small></div>';
                } else {
                    frequentSection.style.display = 'block';
                    frequentContainer.innerHTML = frequentItems.map(item => `
                        <div class="item-tile frequent" onclick="addFrequentItem('${item.name.replace(/'/g, "\\'")}', ${item.avgPrice})" title="Click to add to your list">
                            <span class="item-tile-icon">${getItemIcon(item.name)}</span>
                            <div class="item-tile-name">${item.name}</div>
                            <div class="item-tile-qty">Bought ${item.count}√ó</div>
                            ${item.avgPrice > 0 ? `<div class="item-tile-price">~$${item.avgPrice.toFixed(2)}</div>` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('‚ùå Failed to load frequently bought items:', error);
                frequentSection.style.display = 'block';
                frequentContainer.innerHTML = '<div class="empty-section">Unable to load suggestions. Upload receipts to enable this feature! üìä</div>';
            }
        }
        
        async function addFrequentItem(itemName, avgPrice) {
            if (!currentListId) return;
            
            try {
                const response = await fetch(`/api/shopping-lists/${currentListId}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        itemName: itemName,
                        quantity: 1
                    })
                });
                
                if (response.ok) {
                    // Reload the list to show the new item
                    await viewList(currentListId);
                } else {
                    alert('Failed to add item');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function loadPriceAlerts(listId) {
            try {
                const response = await fetch(`/api/shopping-lists/${listId}/price-alerts`);
                const alerts = await response.json();

                const card = document.getElementById('priceAlertsCard');
                const container = document.getElementById('priceAlertsContainer');

                if (alerts.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';
                container.innerHTML = alerts.map(alert => `
                    <div class="alert success">
                        <strong>üí∞ ${alert.itemName}</strong> is on sale!<br>
                        Now: $${alert.currentPrice.toFixed(2)} (was $${alert.previousPrice.toFixed(2)}) at ${alert.vendor}<br>
                        Save $${alert.savingsAmount.toFixed(2)} (${alert.savingsPercent.toFixed(0)}% off)
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load price alerts:', error);
            }
        }

        function showCreateListModal() {
            document.getElementById('createListModal').classList.add('show');
        }

        function hideCreateListModal() {
            document.getElementById('createListModal').classList.remove('show');
            document.getElementById('listName').value = '';
        }

        function showAddItemModal() {
            document.getElementById('addItemModal').classList.add('show');
        }

        function hideAddItemModal() {
            document.getElementById('addItemModal').classList.remove('show');
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '1';
        }

        function hideViewListModal() {
            document.getElementById('viewListModal').classList.remove('show');
            currentListId = null;
        }

        async function createList() {
            const name = document.getElementById('listName').value.trim();
            if (!name) {
                alert('Please enter a list name');
                return;
            }

            try {
                const response = await fetch('/api/shopping-lists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    hideCreateListModal();
                    loadLists();
                } else {
                    alert('Failed to create list');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function generateHealthyList() {
            if (!confirm('Generate a shopping list from your healthy purchases in the last 30 days?')) {
                return;
            }

            try {
                console.log('ü•ó Generating healthy list...');
                const response = await fetch('/api/shopping-lists/generate?daysBack=30', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    console.log('‚úÖ Healthy list generated');
                    await loadLists();
                    const result = await response.json();
                    alert(`‚úÖ Healthy shopping list "${result.name}" generated with ${result.items?.length || 0} items!`);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Failed to generate list:', errorData);
                    alert(`Failed to generate list: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error generating list:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function addItem() {
            const itemName = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('itemQuantity').value);

            if (!itemName) {
                alert('Please enter an item name');
                return;
            }

            try {
                console.log('Adding item:', { listId: currentListId, itemName, quantity });
                const response = await fetch(`/api/shopping-lists/${currentListId}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemName, quantity })
                });

                if (response.ok) {
                    console.log('‚úÖ Item added successfully');
                    hideAddItemModal();
                    await viewList(currentListId);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Failed to add item:', errorData);
                    alert(`Failed to add item: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error adding item:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function toggleItemPurchased(itemId, isPurchased) {
            try {
                await fetch(`/api/shopping-lists/items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isPurchased })
                });
                // Reload the list to update the view
                await viewList(currentListId);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function removeItem(itemId) {
            if (!confirm('Remove this item from the list?')) {
                return;
            }

            try {
                const response = await fetch(`/api/shopping-lists/items/${itemId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    await viewList(currentListId);
                } else {
                    alert('Failed to remove item');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function deleteList() {
            if (!confirm('Delete this entire shopping list? This cannot be undone.')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Deleting list:', currentListId);
                const response = await fetch(`/api/shopping-lists/${currentListId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('‚úÖ List deleted');
                    hideViewListModal();
                    await loadLists();
                    alert('‚úÖ Shopping list deleted');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Failed to delete list:', errorData);
                    alert(`Failed to delete list: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error deleting list:', error);
                alert(`Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
